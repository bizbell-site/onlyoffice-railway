name: Build SDKJS with HWP Shortcuts

on:
  workflow_dispatch:  # 수동 실행
  push:
    branches: [main]
    paths:
      - 'patches/**'
      - '.github/workflows/build-sdkjs.yml'

jobs:
  build-sdkjs:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java (required for SDKJS build)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Clone SDKJS
        run: |
          git clone --depth 1 https://github.com/ONLYOFFICE/sdkjs.git /tmp/sdkjs
          echo "SDKJS cloned successfully"

      - name: Apply HWP Shortcuts Patch
        run: |
          # Shortcuts.js 파일에 HWP 단축키 추가
          SHORTCUTS_FILE="/tmp/sdkjs/word/Editor/Shortcuts.js"

          if [ -f "$SHORTCUTS_FILE" ]; then
            echo "Found Shortcuts.js, applying HWP shortcuts patch..."

            # 파일 끝에 HWP 단축키 코드 추가
            cat >> "$SHORTCUTS_FILE" << 'HWPEOF'

// ============================================
// HWP (한글) 스타일 단축키 - BizBell Custom
// ============================================
(function() {
  if (typeof window === 'undefined') return;

  var initHwpShortcuts = function() {
    if (typeof Asc === 'undefined' || !Asc.c_oAscDocumentShortcutType || !Asc.c_oAscDefaultShortcuts) {
      setTimeout(initHwpShortcuts, 500);
      return;
    }

    var t = Asc.c_oAscDocumentShortcutType;
    var d = Asc.c_oAscDefaultShortcuts;

    function addShortcut(type, keyCode, ctrl, shift, alt, meta) {
      if (type === undefined) return;
      var s = new AscCommon.AscShortcut(type, keyCode, ctrl, shift, alt, meta);
      if (Array.isArray(d[type])) d[type].push(s);
      else if (d[type]) d[type] = [d[type], s];
      else d[type] = s;
    }

    // Alt+L: 글자 모양 (Font Dialog)
    addShortcut(t.FontPanelOpen, 76, false, false, true, false);

    // Alt+T: 문단 모양 (Paragraph Dialog)
    addShortcut(t.ParagraphPanelOpen, 84, false, false, true, false);

    // Ctrl+F10: 특수문자 (Insert Symbol)
    if (t.InsertSymbol !== undefined) {
      addShortcut(t.InsertSymbol, 121, true, false, false, false);
    }

    console.log('[BizBell] HWP shortcuts: Alt+L, Alt+T, Ctrl+F10');
  };

  if (document.readyState === 'complete') initHwpShortcuts();
  else window.addEventListener('load', initHwpShortcuts);
})();
// ============================================
HWPEOF

            echo "HWP shortcuts patch applied"
          else
            echo "ERROR: Shortcuts.js not found!"
            exit 1
          fi

      - name: Build SDKJS
        run: |
          cd /tmp/sdkjs/build
          npm install -g grunt-cli
          npm ci
          grunt --level=WHITESPACE_ONLY 2>&1 || grunt 2>&1 || echo "Build completed with warnings"

      - name: Copy built files
        run: |
          mkdir -p sdkjs-custom/word
          mkdir -p sdkjs-custom/common

          # 빌드된 파일 복사
          if [ -d "/tmp/sdkjs/deploy/sdkjs/word" ]; then
            cp -r /tmp/sdkjs/deploy/sdkjs/word/* sdkjs-custom/word/
            cp -r /tmp/sdkjs/deploy/sdkjs/common/* sdkjs-custom/common/ 2>/dev/null || true
            echo "Built SDKJS files copied"
          else
            # 빌드 결과가 다른 위치에 있을 수 있음
            find /tmp/sdkjs -name "*.js" -path "*/word/*" | head -20
            echo "Checking alternative build output locations..."

            # 소스 파일 직접 복사 (빌드 실패 시 폴백)
            cp -r /tmp/sdkjs/word/* sdkjs-custom/word/
            cp -r /tmp/sdkjs/common/* sdkjs-custom/common/ 2>/dev/null || true
          fi

          ls -la sdkjs-custom/

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # .gitkeep 제거
          rm -f sdkjs-custom/.gitkeep

          git add sdkjs-custom/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "build: Update SDKJS with HWP shortcuts

            Auto-generated by GitHub Actions

            Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
            git push
          fi
