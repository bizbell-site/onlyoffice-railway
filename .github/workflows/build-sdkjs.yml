name: Build SDKJS with HWP Shortcuts

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'patches/**'
      - '.github/workflows/build-sdkjs.yml'

jobs:
  build-sdkjs:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Clone SDKJS
        run: |
          git clone --depth 1 https://github.com/ONLYOFFICE/sdkjs.git /tmp/sdkjs
          echo "SDKJS cloned successfully"

      - name: Apply HWP Shortcuts Patch
        run: |
          SHORTCUTS_FILE="/tmp/sdkjs/word/Editor/Shortcuts.js"
          if [ -f "$SHORTCUTS_FILE" ]; then
            echo "Applying HWP shortcuts patch..."
            cat patches/hwp-shortcuts-patch.js >> "$SHORTCUTS_FILE"
            echo "Patch applied"
          else
            echo "ERROR: Shortcuts.js not found"
            exit 1
          fi

      - name: Build SDKJS
        run: |
          cd /tmp/sdkjs/build
          npm install -g grunt-cli
          npm ci
          grunt --level=WHITESPACE_ONLY || grunt || echo "Build completed"

      - name: Copy built files
        run: |
          mkdir -p sdkjs-custom/word
          mkdir -p sdkjs-custom/common
          if [ -d "/tmp/sdkjs/deploy/sdkjs/word" ]; then
            cp -r /tmp/sdkjs/deploy/sdkjs/word/* sdkjs-custom/word/
            cp -r /tmp/sdkjs/deploy/sdkjs/common/* sdkjs-custom/common/ 2>/dev/null || true
          else
            cp -r /tmp/sdkjs/word/* sdkjs-custom/word/
            cp -r /tmp/sdkjs/common/* sdkjs-custom/common/ 2>/dev/null || true
          fi
          ls -la sdkjs-custom/

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          rm -f sdkjs-custom/.gitkeep
          git add sdkjs-custom/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "build: Update SDKJS with HWP shortcuts"
            git push
          fi
