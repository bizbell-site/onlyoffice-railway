name: Build OnlyOffice Document Server with HWP Shortcuts

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-documentserver:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3시간 (전체 빌드에 시간 소요)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          df -h

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            curl \
            wget \
            build-essential \
            libcurl4-openssl-dev \
            libssl-dev \
            libglib2.0-dev \
            libfreetype6-dev \
            libfontconfig1-dev \
            libx11-dev \
            libxrender-dev \
            libpng-dev \
            libjpeg-dev \
            libgif-dev \
            libicu-dev \
            libharfbuzz-dev \
            qt5-qmake \
            qtbase5-dev \
            p7zip-full \
            nodejs \
            npm

      - name: Clone build_tools
        run: |
          git clone --depth 1 https://github.com/nicedoc/build_tools.git /tmp/build_tools
          cd /tmp/build_tools
          git submodule update --init --recursive || true

      - name: Configure build
        run: |
          cd /tmp/build_tools
          # 빌드 설정 파일 생성
          cat > configure.py << 'EOF'
          import config

          config.branding = ""
          config.option("platform", "linux_64")
          config.option("module", "server")
          config.option("clean", "0")
          config.option("sdkjs-branding", "")
          EOF

      - name: Apply HWP shortcuts patch to SDKJS
        run: |
          # build_tools가 소스를 다운로드한 후 패치 적용
          cd /tmp/build_tools
          python configure.py
          python make.py --platform linux_64 --module server --update 1 --clean 0

          # SDKJS Keyboard.js 패치
          KEYBOARD_FILE="/tmp/build_tools/out/linux_64/sdkjs/word/Editor/Keyboard.js"
          if [ -f "$KEYBOARD_FILE" ]; then
            echo "Applying HWP shortcuts patch to Keyboard.js..."
            cat ${{ github.workspace }}/patches/hwp-keyboard-patch.js >> "$KEYBOARD_FILE"
            echo "Patch applied successfully"
          else
            echo "WARNING: Keyboard.js not found at expected location"
            find /tmp/build_tools -name "Keyboard.js" 2>/dev/null | head -5
          fi

      - name: Build Document Server
        run: |
          cd /tmp/build_tools
          python make.py --platform linux_64 --module server --clean 0

      - name: Create Docker image
        run: |
          cd /tmp/build_tools
          # 빌드 결과물 확인
          ls -la out/linux_64/ || true

          # Docker 이미지 생성을 위한 파일 복사
          mkdir -p ${{ github.workspace }}/documentserver-build
          if [ -d "out/linux_64/documentserver" ]; then
            cp -r out/linux_64/documentserver/* ${{ github.workspace }}/documentserver-build/
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentserver-build
          path: documentserver-build/
          retention-days: 7
          if-no-files-found: warn
