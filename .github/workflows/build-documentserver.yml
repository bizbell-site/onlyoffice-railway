name: Build OnlyOffice Document Server with HWP Shortcuts

on:
  workflow_dispatch:

jobs:
  build-sdkjs:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Clone SDKJS directly
        run: |
          git clone --depth 1 https://github.com/ONLYOFFICE/sdkjs.git /tmp/sdkjs
          echo "SDKJS cloned from ONLYOFFICE/sdkjs"
          ls -la /tmp/sdkjs/
          ls -la /tmp/sdkjs/word/ || echo "No word folder"
          ls -la /tmp/sdkjs/word/Editor/ || echo "No Editor folder"

      - name: Verify Shortcuts.js exists
        run: |
          echo "Looking for Shortcuts.js..."
          find /tmp/sdkjs -name "Shortcuts.js" 2>/dev/null

          if [ -f "/tmp/sdkjs/word/Editor/Shortcuts.js" ]; then
            echo "Found: /tmp/sdkjs/word/Editor/Shortcuts.js"
            head -100 /tmp/sdkjs/word/Editor/Shortcuts.js
          else
            echo "Shortcuts.js not at expected location"
            ls -la /tmp/sdkjs/word/Editor/ || echo "No word/Editor folder"
          fi

      - name: Apply HWP shortcuts patch
        run: |
          SHORTCUTS_FILE="/tmp/sdkjs/word/Editor/Shortcuts.js"

          if [ -f "$SHORTCUTS_FILE" ]; then
            echo "Applying HWP shortcuts patch to $SHORTCUTS_FILE"
            cat ${{ github.workspace }}/patches/hwp-shortcuts-patch.js >> "$SHORTCUTS_FILE"
            echo "=== Patch applied. Last 60 lines of Shortcuts.js ==="
            tail -60 "$SHORTCUTS_FILE"
          else
            echo "ERROR: Shortcuts.js not found at $SHORTCUTS_FILE"
            exit 1
          fi

      - name: Install build dependencies
        run: |
          cd /tmp/sdkjs/build
          npm install -g grunt-cli
          npm ci || npm install

      - name: Build SDKJS
        run: |
          cd /tmp/sdkjs/build
          grunt --level=WHITESPACE_ONLY 2>&1 || grunt 2>&1 || echo "Build attempted"

          echo "=== Checking build output ==="
          ls -la /tmp/sdkjs/deploy/ 2>/dev/null || echo "No deploy folder"
          ls -la /tmp/sdkjs/build/deploy/ 2>/dev/null || echo "No build/deploy folder"

      - name: Collect build output
        run: |
          mkdir -p ${{ github.workspace }}/sdkjs-build/word
          mkdir -p ${{ github.workspace }}/sdkjs-build/common

          # Try multiple possible output locations
          if [ -d "/tmp/sdkjs/deploy/sdkjs" ]; then
            echo "Copying from /tmp/sdkjs/deploy/sdkjs/"
            cp -r /tmp/sdkjs/deploy/sdkjs/word/* ${{ github.workspace }}/sdkjs-build/word/ 2>/dev/null || true
            cp -r /tmp/sdkjs/deploy/sdkjs/common/* ${{ github.workspace }}/sdkjs-build/common/ 2>/dev/null || true
          elif [ -d "/tmp/sdkjs/build/deploy" ]; then
            echo "Copying from /tmp/sdkjs/build/deploy/"
            cp -r /tmp/sdkjs/build/deploy/sdkjs/word/* ${{ github.workspace }}/sdkjs-build/word/ 2>/dev/null || true
            cp -r /tmp/sdkjs/build/deploy/sdkjs/common/* ${{ github.workspace }}/sdkjs-build/common/ 2>/dev/null || true
          else
            echo "No deploy folder found, copying source files"
            cp -r /tmp/sdkjs/word/* ${{ github.workspace }}/sdkjs-build/word/ 2>/dev/null || true
            cp -r /tmp/sdkjs/common/* ${{ github.workspace }}/sdkjs-build/common/ 2>/dev/null || true
          fi

          echo "=== Build output ==="
          ls -la ${{ github.workspace }}/sdkjs-build/
          ls -la ${{ github.workspace }}/sdkjs-build/word/ | head -20

      - name: Commit and push SDKJS build
        run: |
          # sdkjs-build 폴더를 sdkjs-custom으로 이동
          rm -rf ${{ github.workspace }}/sdkjs-custom
          mv ${{ github.workspace }}/sdkjs-build ${{ github.workspace }}/sdkjs-custom

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add sdkjs-custom/
          git commit -m "chore: add built SDKJS with HWP shortcuts (grunt build)" || echo "No changes to commit"
          git push
