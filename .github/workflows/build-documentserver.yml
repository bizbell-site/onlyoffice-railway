name: Build OnlyOffice Document Server with HWP Shortcuts

on:
  workflow_dispatch:

jobs:
  build-documentserver:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          df -h

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git curl wget build-essential \
            libcurl4-openssl-dev libssl-dev \
            libglib2.0-dev libfreetype6-dev \
            libfontconfig1-dev libx11-dev \
            libxrender-dev libpng-dev \
            libjpeg-dev libgif-dev \
            libicu-dev libharfbuzz-dev \
            qt5-qmake qtbase5-dev \
            p7zip-full nodejs npm \
            default-jdk

      - name: Clone build_tools
        run: |
          git clone https://github.com/nicedoc/build_tools.git /tmp/build_tools
          cd /tmp/build_tools

      - name: Fetch sources and apply patch
        run: |
          cd /tmp/build_tools

          # 소스 다운로드만 먼저 실행
          python3 make.py --platform linux_64 --module sdkjs --update 1 --no-build 1 || true

          # SDKJS 소스 위치 찾기
          echo "Finding Keyboard.js..."
          find /tmp -name "Keyboard.js" -path "*/word/*" 2>/dev/null | head -5

          # 가능한 위치들 확인
          for dir in "/tmp/build_tools/sdkjs" "/tmp/build_tools/core/sdkjs" "/tmp/sdkjs"; do
            if [ -d "$dir" ]; then
              echo "Found sdkjs at: $dir"
              ls -la "$dir" || true
            fi
          done

      - name: Apply HWP shortcuts patch
        run: |
          # SDKJS Keyboard.js 패치
          KEYBOARD_FILE=$(find /tmp -name "Keyboard.js" -path "*/word/Editor/*" 2>/dev/null | head -1)

          if [ -n "$KEYBOARD_FILE" ] && [ -f "$KEYBOARD_FILE" ]; then
            echo "Found Keyboard.js at: $KEYBOARD_FILE"
            echo "Applying HWP shortcuts patch..."
            cat ${{ github.workspace }}/patches/hwp-keyboard-patch.js >> "$KEYBOARD_FILE"
            echo "Patch applied successfully"
            tail -50 "$KEYBOARD_FILE"
          else
            echo "ERROR: Keyboard.js not found"
            echo "Searching for any Keyboard.js files..."
            find /tmp -name "Keyboard.js" 2>/dev/null
            exit 1
          fi

      - name: Build SDKJS
        run: |
          cd /tmp/build_tools
          python3 make.py --platform linux_64 --module sdkjs --clean 0

      - name: Copy built SDKJS files
        run: |
          mkdir -p ${{ github.workspace }}/sdkjs-build

          # 빌드 결과물 찾기
          echo "Searching for built sdkjs files..."
          find /tmp/build_tools -type d -name "deploy" 2>/dev/null | head -5

          # 빌드된 SDKJS 복사
          if [ -d "/tmp/build_tools/out/linux_64/sdkjs" ]; then
            cp -r /tmp/build_tools/out/linux_64/sdkjs/* ${{ github.workspace }}/sdkjs-build/
          elif [ -d "/tmp/build_tools/sdkjs/deploy" ]; then
            cp -r /tmp/build_tools/sdkjs/deploy/sdkjs/* ${{ github.workspace }}/sdkjs-build/
          fi

          ls -la ${{ github.workspace }}/sdkjs-build/ || echo "No files copied"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sdkjs-hwp-build
          path: sdkjs-build/
          retention-days: 7
          if-no-files-found: warn
