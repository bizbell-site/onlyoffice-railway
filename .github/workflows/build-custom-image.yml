name: Build Custom OnlyOffice Image with HWP Shortcuts

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'patches/**'
      - 'Dockerfile.hwp'
      - '.github/workflows/build-custom-image.yml'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/onlyoffice-hwp

jobs:
  build-sdkjs:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java (for Closure Compiler)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Clone ONLYOFFICE SDKJS
        run: |
          git clone --depth 1 https://github.com/nicedoc/nicedoc-sdkjs.git /tmp/sdkjs || \
          git clone --depth 1 https://github.com/ONLYOFFICE/sdkjs.git /tmp/sdkjs

          echo "=== SDKJS structure ==="
          ls -la /tmp/sdkjs/
          ls -la /tmp/sdkjs/word/Editor/ 2>/dev/null | head -20 || echo "No word/Editor"

      - name: Apply HWP shortcuts patch
        run: |
          SHORTCUTS_FILE="/tmp/sdkjs/word/Editor/Shortcuts.js"

          if [ ! -f "$SHORTCUTS_FILE" ]; then
            echo "Shortcuts.js not found, searching..."
            find /tmp/sdkjs -name "Shortcuts.js" 2>/dev/null
            SHORTCUTS_FILE=$(find /tmp/sdkjs -name "Shortcuts.js" -path "*/word/*" 2>/dev/null | head -1)
          fi

          if [ -f "$SHORTCUTS_FILE" ]; then
            echo "Found: $SHORTCUTS_FILE"
            echo "=== Before patch ==="
            tail -20 "$SHORTCUTS_FILE"

            cat ${{ github.workspace }}/patches/hwp-shortcuts-patch.js >> "$SHORTCUTS_FILE"

            echo "=== After patch ==="
            tail -60 "$SHORTCUTS_FILE"
          else
            echo "ERROR: Shortcuts.js not found"
            exit 1
          fi

      - name: Build SDKJS
        run: |
          cd /tmp/sdkjs

          if [ -d "build" ]; then
            cd build
            npm install -g grunt-cli
            npm ci || npm install

            echo "=== Building SDKJS ==="
            grunt --level=WHITESPACE_ONLY 2>&1 || grunt 2>&1 || echo "Build attempted"
          else
            echo "No build directory, will use source files"
          fi

      - name: Collect build output
        run: |
          mkdir -p ${{ github.workspace }}/sdkjs-build

          if [ -d "/tmp/sdkjs/deploy/sdkjs" ]; then
            echo "Using deploy output"
            cp -r /tmp/sdkjs/deploy/sdkjs/* ${{ github.workspace }}/sdkjs-build/
          elif [ -d "/tmp/sdkjs/build/deploy/sdkjs" ]; then
            echo "Using build/deploy output"
            cp -r /tmp/sdkjs/build/deploy/sdkjs/* ${{ github.workspace }}/sdkjs-build/
          else
            echo "Using source files"
            cp -r /tmp/sdkjs/word ${{ github.workspace }}/sdkjs-build/
            cp -r /tmp/sdkjs/common ${{ github.workspace }}/sdkjs-build/
            cp -r /tmp/sdkjs/cell ${{ github.workspace }}/sdkjs-build/ 2>/dev/null || true
            cp -r /tmp/sdkjs/slide ${{ github.workspace }}/sdkjs-build/ 2>/dev/null || true
          fi

          echo "=== Build output ==="
          ls -la ${{ github.workspace }}/sdkjs-build/
          du -sh ${{ github.workspace }}/sdkjs-build/

      - name: Upload SDKJS build
        uses: actions/upload-artifact@v4
        with:
          name: sdkjs-hwp
          path: sdkjs-build/
          retention-days: 1

  build-docker:
    needs: build-sdkjs
    runs-on: ubuntu-latest
    timeout-minutes: 60

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download SDKJS build
        uses: actions/download-artifact@v4
        with:
          name: sdkjs-hwp
          path: sdkjs-build/

      - name: Create Dockerfile for custom image
        run: |
          cat > Dockerfile.hwp << 'DOCKERFILE'
          FROM onlyoffice/documentserver:latest

          # ============================================
          # 한글 폰트 설치
          # ============================================
          RUN apt-get update && apt-get install -y --no-install-recommends \
              fonts-nanum \
              fonts-nanum-coding \
              fonts-nanum-extra \
              fonts-noto-cjk \
              fonts-noto-cjk-extra \
              fonts-unfonts-core \
              fonts-unfonts-extra \
              fonts-baekmuk \
              fonts-alee \
              && rm -rf /var/lib/apt/lists/*

          # ============================================
          # HWP 패치된 SDKJS 복사
          # ============================================
          COPY sdkjs-build/ /tmp/sdkjs-patched/

          # Word SDK 교체
          RUN if [ -f /tmp/sdkjs-patched/word/sdk-all.js ]; then \
                cp /tmp/sdkjs-patched/word/sdk-all.js /var/www/onlyoffice/documentserver/sdkjs/word/sdk-all.js; \
                echo "sdk-all.js replaced"; \
              fi && \
              if [ -f /tmp/sdkjs-patched/word/sdk-all-min.js ]; then \
                cp /tmp/sdkjs-patched/word/sdk-all-min.js /var/www/onlyoffice/documentserver/sdkjs/word/sdk-all-min.js; \
                echo "sdk-all-min.js replaced"; \
              fi && \
              rm -rf /tmp/sdkjs-patched

          # ============================================
          # 폰트 및 캐시 재생성 (해시 재계산)
          # ============================================
          RUN fc-cache -fv && \
              /usr/bin/documentserver-generate-allfonts.sh

          # NGINX 설정 (Railway 호환)
          RUN mv /etc/init.d/nginx /etc/init.d/nginx.orig && \
              printf '#!/bin/bash\nrm -f /etc/nginx/sites-enabled/default\nfor f in /etc/nginx/conf.d/*.conf; do\n  [ -f "$f" ] && sed -i "s/listen 80;/listen 0.0.0.0:80;/g" "$f"\n  [ -f "$f" ] && sed -i "s/listen \\[::]:80 default_server;/#listen [::]:80 default_server;/g" "$f"\ndone\nexec /etc/init.d/nginx.orig "$@"\n' > /etc/init.d/nginx && \
              chmod +x /etc/init.d/nginx

          EXPOSE 80
          DOCKERFILE

          echo "=== Dockerfile.hwp created ==="
          cat Dockerfile.hwp

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.hwp
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image info
        run: |
          echo "============================================"
          echo "Docker image pushed successfully!"
          echo "============================================"
          echo ""
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "To use in Railway:"
          echo "1. Go to Railway dashboard"
          echo "2. Select your OnlyOffice service"
          echo "3. Settings > Source"
          echo "4. Change to 'Docker Image'"
          echo "5. Enter: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "============================================"
