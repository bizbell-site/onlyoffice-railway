name: Build Full OnlyOffice Document Server

on:
  workflow_dispatch:

jobs:
  build-documentserver:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6시간

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          echo "=== Before cleanup ==="
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache
          docker system prune -af || true
          echo "=== After cleanup ==="
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git python3 python3-pip \
            build-essential cmake \
            libcurl4-openssl-dev libssl-dev \
            libglib2.0-dev libfreetype6-dev \
            libfontconfig1-dev libx11-dev \
            libxrender-dev libpng-dev \
            libjpeg-dev libgif-dev \
            libicu-dev libharfbuzz-dev \
            qt5-qmake qtbase5-dev \
            p7zip-full default-jdk \
            nodejs npm

      - name: Clone build_tools
        run: |
          git clone https://github.com/nicedoc/build_tools.git /tmp/build_tools
          cd /tmp/build_tools
          echo "Build tools cloned"

      - name: Fetch all sources
        run: |
          cd /tmp/build_tools
          # configure.py로 설정 생성
          python3 configure.py

          # 소스 다운로드 (빌드 없이)
          python3 make.py || true

          # sdkjs 소스 확인
          echo "=== Checking sdkjs location ==="
          find /tmp/build_tools -type d -name "sdkjs" 2>/dev/null | head -5
          find /tmp/build_tools -name "Shortcuts.js" 2>/dev/null | head -10

      - name: Apply HWP shortcuts patch
        run: |
          # Find Shortcuts.js in sdkjs
          SHORTCUTS_FILE=$(find /tmp/build_tools -path "*/sdkjs/word/Editor/Shortcuts.js" 2>/dev/null | head -1)

          if [ -z "$SHORTCUTS_FILE" ]; then
            echo "Searching for Shortcuts.js in different locations..."
            find /tmp/build_tools -name "Shortcuts.js" 2>/dev/null
            SHORTCUTS_FILE=$(find /tmp/build_tools -name "Shortcuts.js" -path "*/word/*" 2>/dev/null | head -1)
          fi

          if [ -n "$SHORTCUTS_FILE" ] && [ -f "$SHORTCUTS_FILE" ]; then
            echo "Found Shortcuts.js at: $SHORTCUTS_FILE"
            echo "Applying HWP shortcuts patch..."
            cat ${{ github.workspace }}/patches/hwp-shortcuts-patch.js >> "$SHORTCUTS_FILE"
            echo "Patch applied"
            tail -60 "$SHORTCUTS_FILE"
          else
            echo "WARNING: Shortcuts.js not found, continuing without patch"
          fi

      - name: Build Document Server
        run: |
          cd /tmp/build_tools
          python3 make.py --platform linux_64 --module server --clean 0
        timeout-minutes: 240

      - name: Check build output
        run: |
          echo "=== Checking build output ==="
          ls -la /tmp/build_tools/out/ 2>/dev/null || echo "No out folder"
          ls -la /tmp/build_tools/out/linux_64/ 2>/dev/null || echo "No linux_64 folder"
          find /tmp/build_tools/out -name "*.deb" 2>/dev/null | head -5
          find /tmp/build_tools/out -name "documentserver*" -type d 2>/dev/null | head -5

      - name: Create Docker image
        run: |
          cd /tmp/build_tools

          # Find the built document server
          DS_PATH=$(find /tmp/build_tools/out -name "documentserver" -type d 2>/dev/null | head -1)

          if [ -n "$DS_PATH" ]; then
            echo "Found Document Server at: $DS_PATH"
            mkdir -p ${{ github.workspace }}/documentserver-build
            cp -r "$DS_PATH"/* ${{ github.workspace }}/documentserver-build/
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentserver-full-build
          path: documentserver-build/
          retention-days: 7
          if-no-files-found: warn
