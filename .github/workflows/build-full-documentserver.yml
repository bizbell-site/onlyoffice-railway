name: Build Full OnlyOffice Document Server

on:
  workflow_dispatch:

jobs:
  build-documentserver:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6시간

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          echo "=== Before cleanup ==="
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache
          docker system prune -af || true
          echo "=== After cleanup ==="
          df -h

      - name: Clone official ONLYOFFICE SDKJS
        run: |
          # 공식 ONLYOFFICE sdkjs 클론
          git clone --depth 1 https://github.com/ONLYOFFICE/sdkjs.git /tmp/sdkjs

          echo "=== SDKJS structure ==="
          ls -la /tmp/sdkjs/
          ls -la /tmp/sdkjs/word/Editor/ | head -20

          # Shortcuts.js 확인
          if [ -f "/tmp/sdkjs/word/Editor/Shortcuts.js" ]; then
            echo "✓ Found Shortcuts.js"
            head -50 /tmp/sdkjs/word/Editor/Shortcuts.js
          else
            echo "✗ Shortcuts.js not found"
            exit 1
          fi

      - name: Apply HWP shortcuts patch
        run: |
          SHORTCUTS_FILE="/tmp/sdkjs/word/Editor/Shortcuts.js"

          echo "=== Before patch (last 30 lines) ==="
          tail -30 "$SHORTCUTS_FILE"

          echo ""
          echo "=== Applying HWP shortcuts patch ==="
          cat ${{ github.workspace }}/patches/hwp-shortcuts-patch.js >> "$SHORTCUTS_FILE"

          echo ""
          echo "=== After patch (last 60 lines) ==="
          tail -60 "$SHORTCUTS_FILE"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java (for Closure Compiler)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Build SDKJS
        run: |
          cd /tmp/sdkjs/build

          echo "=== Installing dependencies ==="
          npm install -g grunt-cli
          npm ci || npm install

          echo "=== Running grunt build ==="
          # WHITESPACE_ONLY로 빌드 (더 빠름)
          grunt --level=WHITESPACE_ONLY 2>&1 || {
            echo "WHITESPACE_ONLY failed, trying default build..."
            grunt 2>&1 || echo "Default grunt also failed"
          }

          echo "=== Checking build output ==="
          ls -la /tmp/sdkjs/deploy/ 2>/dev/null || echo "No deploy folder"
          find /tmp/sdkjs -type d -name "deploy" 2>/dev/null | head -5
          find /tmp/sdkjs -name "word*.js" 2>/dev/null | head -10

      - name: Collect build artifacts
        run: |
          mkdir -p ${{ github.workspace }}/sdkjs-build

          # Try multiple possible output locations
          if [ -d "/tmp/sdkjs/deploy/sdkjs" ]; then
            echo "Copying from /tmp/sdkjs/deploy/sdkjs/"
            cp -r /tmp/sdkjs/deploy/sdkjs/* ${{ github.workspace }}/sdkjs-build/
          elif [ -d "/tmp/sdkjs/build/deploy" ]; then
            echo "Copying from /tmp/sdkjs/build/deploy/"
            cp -r /tmp/sdkjs/build/deploy/* ${{ github.workspace }}/sdkjs-build/
          else
            echo "No deploy folder found, listing all output locations:"
            find /tmp/sdkjs -type f -name "*.js" -newer /tmp/sdkjs/.git 2>/dev/null | head -20

            # Fallback: copy source with patch
            echo "Copying patched source files..."
            cp -r /tmp/sdkjs/word ${{ github.workspace }}/sdkjs-build/
            cp -r /tmp/sdkjs/common ${{ github.workspace }}/sdkjs-build/
          fi

          echo "=== Build output ==="
          ls -la ${{ github.workspace }}/sdkjs-build/
          du -sh ${{ github.workspace }}/sdkjs-build/

      - name: Upload SDKJS build
        uses: actions/upload-artifact@v4
        with:
          name: sdkjs-hwp-build
          path: sdkjs-build/
          retention-days: 30

      - name: Commit built SDKJS to repo
        run: |
          # sdkjs-build를 레포에 커밋
          rm -rf ${{ github.workspace }}/sdkjs-custom
          mv ${{ github.workspace }}/sdkjs-build ${{ github.workspace }}/sdkjs-custom

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add sdkjs-custom/
          git commit -m "chore: add SDKJS build with HWP shortcuts patch" || echo "No changes to commit"
          git push
